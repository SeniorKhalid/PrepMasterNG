<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PrepMaster NG</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f8f9fa; font-size: 1rem; }
    .card { max-width: 700px; margin: 20px auto; }
    .progress-bar { transition: width 1s linear; }
    #result, #summary { font-size: 1.1em; }
    @media (max-width: 576px) {
      body { font-size: 0.9rem; }
      h1 { font-size: 1.5rem; }
      .btn { font-size: 1rem; padding: 12px; }
      .card { margin: 10px; }
    }
  </style>
</head>
<body>
  <!-- üîê Login Enforcement -->
  <script>
    if (!localStorage.getItem("username")) {
      window.location.href = "/auth";
    }
  </script>

  <div class="container-fluid px-2">
    <!-- üßæ Onboarding Form -->
    <div class="container mt-4" id="onboarding-section">
      <form id="onboarding-form" class="card p-4 shadow">
        <h2 class="mb-3 text-center">üéØ Get Started</h2>
        <div class="mb-3">
          <label for="playerName" class="form-label">Your Name</label>
          <input type="text" class="form-control" id="playerName" required>
        </div>
        <div class="mb-3">
          <label for="subject" class="form-label">Subject</label>
          <select class="form-select" id="subject" required>
            <option value="" disabled selected>Loading subjects...</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="timeLimit" class="form-label">Time per Question (seconds)</label>
          <input type="number" class="form-control" id="timeLimit" value="15" min="5" required>
        </div>
        <div class="mb-3">
          <label for="numQuestions" class="form-label">Number of Questions</label>
          <input type="number" class="form-control" id="numQuestions" value="10" min="1" max="20" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">üöÄ Start Quiz</button>
      </form>
    </div>

    <!-- üß† Quiz Card -->
    <div class="card shadow">
      <div class="card-body">
        <h1 class="card-title text-center mb-4">
          üöÄ PrepMaster NG üöÄ<br>
          <small class="text-muted" id="user-greeting"></small>
        </h1>
        <div id="quiz"></div>
        <div id="timer" class="text-danger fw-bold mt-3 sticky-top bg-white p-2"></div>
        <div class="progress mt-2">
          <div id="progress-bar" class="progress-bar bg-danger" style="width:100%"></div>
        </div>
        <div id="result" class="mt-3"></div>
        <div id="summary" class="mt-3"></div>
        <div id="leaderboard" class="mt-4 table-responsive"></div>

        <!-- üîê Dashboard + Logout -->
        <div class="text-center mt-4">
          <a id="dashboard-link" class="btn btn-info me-2" style="display:none">üìä Dashboard</a>
          <button onclick="clearLeaderboard()" class="btn btn-danger me-2">üßπ Clear Leaderboard</button>
          <button onclick="logout()" class="btn btn-outline-secondary">üö™ Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üîä Sounds -->
  <audio id="beep-sound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.mp3" type="audio/mpeg">
  </audio>
  <audio id="celebration-sound">
    <source src="https://actions.google.com/sounds/v1/crowds/applause.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/crowds/applause.mp3" type="audio/mpeg">
  </audio>

  <!-- üß† Script -->
  <script>
    let playerName, subject, numQuestions, timeLimit;
    let currentQuestion = null;
    let timerInterval, timeLeft;
    let score = 0, totalQuestions = 0;

    async function loadSubjects() {
      try {
        const res = await fetch("/subjects");
        const data = await res.json();
        const subjectSelect = document.getElementById("subject");
        subjectSelect.innerHTML = '<option value="" disabled selected>Select a subject</option>';
        data.subjects.forEach(sub => {
          const opt = document.createElement("option");
          opt.value = sub;
          opt.textContent = sub;
          subjectSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to load subjects:", err);
        document.getElementById("subject").innerHTML = '<option disabled>Error loading subjects</option>';
      }
    }

    document.getElementById("onboarding-form").addEventListener("submit", function (e) {
      e.preventDefault();
      playerName = document.getElementById("playerName").value.trim() || "Guest";
      subject = document.getElementById("subject").value.trim();
      timeLimit = parseInt(document.getElementById("timeLimit").value) || 15;
      numQuestions = parseInt(document.getElementById("numQuestions").value) || 10;

      document.getElementById("onboarding-section").style.display = "none";
      startQuiz();
    });

    async function startQuiz() {
      const res = await fetch("/start_quiz", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ subject, name: playerName, num_questions: numQuestions })
      });
      const data = await res.json();
      if (data.error) {
        document.getElementById("quiz").innerHTML = `<p class="text-danger">${data.error}</p>`;
        return;
      }
      currentQuestion = data.first_question;
      totalQuestions = data.total_questions;
      showQuestion(currentQuestion);
    }

    function showQuestion(q) {
      clearInterval(timerInterval);
      if (!q) {
        document.getElementById("quiz").innerHTML = `
          <h2 class="text-center">üéâ Quiz Finished!</h2>
          <div class="text-center">
            <button class="btn btn-success mt-3 w-100" onclick="restartQuiz()">üîÑ Play Again</button>
          </div>`;
        document.getElementById("timer").innerHTML = "";
        document.getElementById("progress-bar").style.width = "0%";
        document.getElementById("celebration-sound").play();

        let percentage = ((score / totalQuestions) * 100).toFixed(2);
        document.getElementById("summary").innerHTML = `
          <div class="alert alert-info mt-3">
            <h4>üìä Your Score Summary</h4>
            <p>You answered <b>${score}</b> out of <b>${totalQuestions}</b> questions correctly.</p>
            <p>That‚Äôs <b>${percentage}%</b>!</p>
          </div>`;
        loadLeaderboard();
        return;
      }

      let html = `<div class="question h5 mb-3">${q.question}</div>`;
      q.options.forEach(opt => {
        html += `<button class="btn btn-outline-primary w-100 mb-2 btn-lg" onclick="submitAnswer('${opt}')">${opt}</button>`;
      });
      document.getElementById("quiz").innerHTML = html;

      timeLeft = timeLimit;
      document.getElementById("timer").innerHTML = `‚è≥ Time left: ${timeLeft}s`;
      document.getElementById("progress-bar").style.width = "100%";

      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerHTML = `‚è≥ Time left: ${timeLeft}s`;
        document.getElementById("progress-bar").style.width = (timeLeft / timeLimit) * 100 + "%";
        if (timeLeft <= 3 && timeLeft > 0) document.getElementById("beep-sound").play();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          autoSubmitWrong();
        }
      }, 1000);
    }

    async function submitAnswer(choice) {
      clearInterval(timerInterval);
      const res = await fetch("/answer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ choice })
      });
      const data = await res.json();

      if (data.correct) {
        score++;
        document.getElementById("result").innerHTML = "<p class='text-success'>‚úÖ Correct!</p>";
      } else {
        document.getElementById("result").innerHTML = `<p class='text-danger'>‚ùå Wrong. Correct answer: ${data.correct_answer}</p>`;
      }

      currentQuestion = data.next_question;

      setTimeout(() => {
        document.getElementById("result").innerHTML = "";
        showQuestion(currentQuestion);
      }, 1500);
    }

    async function autoSubmitWrong() {
      document.getElementById("result").innerHTML = "<p class='text-warning'>‚è∞ Time's up! Moving to next question...</p>";
      await submitAnswer("___NO_ANSWER___");
    }

    async function loadLeaderboard() {
      const resGlobal = await fetch("/leaderboard");
      const globalData = await resGlobal.json();
      const resSubject = await fetch(`/leaderboard/${subject}`);
      const subjectData = await resSubject.json();

      document.getElementById("leaderboard").style.display = "block";

      let html = "<h3>üåç Global Leaderboard</h3><ol class='list-group list-group-numbered'>";
      globalData.forEach(entry => {
        html += `<li class="list-group-item">${entry.name}: ${entry.score} points</li>`;
      });
      html += "</ol>";

      html += `<h3 class="mt-3">üìò ${subject} Leaderboard</h3><ol class='list-group list-group-numbered'>`;
      subjectData.forEach(entry => {
        html += `<li class="list-group-item">${entry.name}: ${entry.score}/${entry.total} (${entry.percentage}%)</li>`;
      });
      html += "</ol>";

      document.getElementById("leaderboard").innerHTML = html;
    }

    function restartQuiz() {
      document.getElementById("onboarding-section").style.display = "block";
      document.getElementById("leaderboard").innerHTML = "";
      document.getElementById("leaderboard").style.display = "none";
      document.getElementById("result").innerHTML = "";
      document.getElementById("summary").innerHTML = "";
      document.getElementById("quiz").innerHTML = "";
    }

    function clearLeaderboard() {
      const password = prompt("Enter admin password:");
      fetch("/clear_leaderboard", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert("‚ùå " + data.error);
        } else {
          alert("‚úÖ " + data.message);
          document.getElementById("leaderboard").innerHTML = "";
          document.getElementById("leaderboard").style.display = "none";
        }
      })
      .catch(err => {
        alert("‚ö†Ô∏è Server error. Please try again later.");
        console.error("Clear leaderboard error:", err);
      });
    }

    function logout() {
      localStorage.removeItem("username");
      window.location.href = "/auth";
    }

    // Load subjects and greet user on page load
    loadSubjects();
    const username = localStorage.getItem("username");
    if (username) {
      document.getElementById("user-greeting").textContent = `Welcome, ${username}!`;
      document.getElementById("playerName").value = username;
      const dashLink = document.getElementById("dashboard-link");
      dashLink.href = `/dashboard/${username}`;
      dashLink.style.display = "inline-block";
    }
  </script>
</body>
</html>
